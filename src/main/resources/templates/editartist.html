<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Artist</title>
</head>
<body>
<h1>Edit Artist</h1>

<form id="artistForm" th:action="@{/editartist}" th:object="${artist}" method="post" onsubmit="reindexAll()">
  <input type="hidden" th:field="*{artistId}" />

  <label>Name:</label>
  <input type="text" th:field="*{name}" />
  <div th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div><br>

  <label>Genre:</label>
  <input type="text" th:field="*{genre}" />
  <div th:if="${#fields.hasErrors('genre')}" th:errors="*{genre}"></div><br>

  <div id="albumsContainer">
    <div th:each="album, aStat : *{albums}" class="album-block">
      <h3>Album [[${aStat.index + 1}]]</h3>
      <input type="hidden" th:field="*{albums[__${aStat.index}__].albumId}" />

      <label>Title:</label>
      <input type="text" th:field="*{albums[__${aStat.index}__].title}" placeholder="Album title" /><br>

      <label>Year:</label>
      <input type="number" th:field="*{albums[__${aStat.index}__].releaseYear}" placeholder="Release year" /><br>

      <h4>Songs</h4>
      <table>
        <thead>
          <tr><th>Title</th><th>Duration</th><th></th></tr>
        </thead>
        <tbody>
          <tr th:each="song, sStat : *{albums[__${aStat.index}__].songs}">
            <input type="hidden" th:field="*{albums[__${aStat.index}__].songs[__${sStat.index}__].songId}" />
            <td><input type="text" th:field="*{albums[__${aStat.index}__].songs[__${sStat.index}__].title}" placeholder="Song title" /></td>
            <td><input type="number" step="0.01" th:field="*{albums[__${aStat.index}__].songs[__${sStat.index}__].duration}" placeholder="Duration" /></td>
            <td><button type="button" onclick="removeSongRow(this)">Delete song</button></td>
          </tr>
        </tbody>
      </table>

      <button type="button" onclick="addSongRow(this)">Add song</button>
      <button type="button" onclick="removeAlbum(this)">Remove album</button>
      <hr>
    </div>
  </div>

  <button type="button" onclick="addAlbum()">Add new album</button><br><br>
  <button type="submit">Save changes</button>
</form>

<a href="/musiclist">Back to list</a>

<script>
function addAlbum() {
  const albumsContainer = document.getElementById("albumsContainer");
  const index = albumsContainer.querySelectorAll(".album-block").length;
  const albumDiv = document.createElement("div");
  albumDiv.classList.add("album-block");

  albumDiv.innerHTML = `
    <h3>Album ${index + 1}</h3>
    <label>Title:</label>
    <input type="text" name="albums[${index}].title" placeholder="Album title"><br>
    <label>Year:</label>
    <input type="number" name="albums[${index}].releaseYear" placeholder="Release year"><br>

    <h4>Songs</h4>
    <table>
      <thead><tr><th>Title</th><th>Duration</th><th></th></tr></thead>
      <tbody>
        ${createSongRowHTML(index, 0)}
        ${createSongRowHTML(index, 1)}
      </tbody>
    </table>

    <button type="button" onclick="addSongRow(this)">Add song</button>
    <button type="button" onclick="removeAlbum(this)">Remove album</button>
    <hr>
  `;
  albumsContainer.appendChild(albumDiv);
}

function createSongRowHTML(albumIndex, songIndex) {
  return `
    <tr>
      <td><input type="text" name="albums[${albumIndex}].songs[${songIndex}].title" placeholder="Song title" /></td>
      <td><input type="number" step="0.01" name="albums[${albumIndex}].songs[${songIndex}].duration" placeholder="Duration" /></td>
      <td><button type="button" onclick="removeSongRow(this)">Delete song</button></td>
    </tr>
  `;
}

function addSongRow(button) {
  const albumBlock = button.closest(".album-block");
  const tbody = albumBlock.querySelector("tbody");
  const albumIndex = Array.from(document.querySelectorAll(".album-block")).indexOf(albumBlock);
  const songIndex = tbody.querySelectorAll("tr").length;

  const row = document.createElement("tr");
  row.innerHTML = createSongRowHTML(albumIndex, songIndex);
  tbody.appendChild(row);
}

function removeSongRow(button) {
  button.closest("tr").remove();
}

function removeAlbum(button) {
  button.closest(".album-block").remove();
  reindexAll();
}

function reindexAll() {
  const albums = document.querySelectorAll(".album-block");
  albums.forEach((album, aIdx) => {
    album.querySelectorAll("input, select, textarea").forEach(input => {
      input.name = input.name.replace(/albums\[\d+\]/, `albums[${aIdx}]`);
    });
    const songs = album.querySelectorAll("tbody tr");
    songs.forEach((row, sIdx) => {
      row.querySelectorAll("input").forEach(input => {
        input.name = input.name.replace(/songs\[\d+\]/, `songs[${sIdx}]`);
      });
    });
  });
}
</script>
</body>
</html>
